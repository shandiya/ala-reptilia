---
title: "Reptiles in the ACT: where and when are they seen?"
author: "Shandiya Balasubramaniam"
output: 
  html_document:
    code_folding: "hide"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r libraries, message = FALSE, warning = FALSE}

library(here)
library(galah)
library(skimr)
library(dplyr)
library(lubridate)
library(stringr)
library(ggplot2)
library(leaflet)
library(leaflet.extras)
library(reactable)
library(scico)

```


```{r get-data, include = FALSE, message = FALSE, echo = FALSE}

# email in .Renviron
galah_config(email = Sys.getenv('EMAIL'), atlas = "Australia")

my_col <- select_columns("decimalLatitude",
                         "decimalLongitude",
                         "eventDate",
                         "scientificName", 
                         "genus",
                         "family",
                         "order",
                         "dataResourceName", 
                         "basisOfRecord", 
                         "cl22",
                         "cl10902")
# download data
reptilia <- ala_occurrences(
  taxa = select_taxa("Reptilia"),
  filters = select_filters(stateProvince = "Australian Capital Territory"),
  columns = my_col,
  mint_doi = TRUE)

citation_text <- ala_citation(reptilia)

# save to avoid repeated downloads
saveRDS(reptilia, here("data", "reptilia"))

```


```{r tidying, message = FALSE}

reptilia <- readRDS(here("data", "reptilia"))

reptilia_tidy <- reptilia %>% 
  filter(cl22 == "Australian Capital Territory") %>% 
  rename(state = cl22, 
         forestType = cl10902) %>% 
  mutate(forestType = na_if(forestType, ""),
         basisOfRecord = tolower(basisOfRecord),
         basisOfRecord = str_replace(basisOfRecord, "_", " "),
         eventDate = as_datetime(eventDate, tz = "Australia/Sydney", format = NULL),
         eventDate = as_date(eventDate, tz = NULL),
         month = month(eventDate))

```

### Data exploration

```{r skim}

skim(reptilia_tidy)

```
**Figure 1** Summary statistics for fields in the dataset of reptile occurrences in the ACT

```{r leaflet, echo = FALSE, layout = "l-page"}

# colour palettes
record_pal <- colorFactor(
  scico(5, palette = 'lajolla'), 
  reptilia_tidy$basisOfRecord
)


forest_pal <- colorFactor(
  scico(11, palette = 'romaO'),
  reptilia_tidy$forestType
)

leaflet(reptilia_tidy) %>% 
  # different basemaps 
  addProviderTiles(providers$CartoDB.Positron, group = "Positron") %>% 
  addProviderTiles(providers$Stamen.Toner, group = "Toner") %>%
  addProviderTiles(providers$Stamen.Terrain, group = "Terrain") %>% 
  # all records
  addCircleMarkers(
    lng = ~decimalLongitude,
    lat = ~decimalLatitude,
    radius = 3,
    stroke = FALSE,
    color = "#41507B",
    fillOpacity = 0.5,
    group = "All records",
    popup = paste0(reptilia_tidy$scientificName)
  ) %>% 
  # colours points by basis of record
  addCircleMarkers(
    lng = ~decimalLongitude,
    lat = ~decimalLatitude,
    radius = 3,
    stroke = FALSE,
    color = ~record_pal(basisOfRecord),
    fillOpacity = 0.5,
    group = "Record basis",
    popup = paste0(reptilia_tidy$scientificName, "<br/>", reptilia_tidy$basisOfRecord)
  ) %>%
  # legend for basis of record
  addLegend(
    "bottomright",
    pal = record_pal,
    values = ~ basisOfRecord,
    title = "Basis of Record",
    opacity = 1,
    group = "Record basis"
  ) %>% 
  # colours points by forest type
  addCircleMarkers(
    lng = ~decimalLongitude,
    lat = ~decimalLatitude,
    radius = 3,
    stroke = FALSE, 
    color = ~forest_pal(forestType),
    fillOpacity = 0.5,
    group = "Forest type",
    popup = paste0(reptilia_tidy$scientificName, "<br/>", reptilia_tidy$forestType)
  ) %>% 
  # legend for forest type
  addLegend(
    "bottomright",
    pal = forest_pal,
    values = ~ forestType,
    title = "Forest Type",
    opacity = 1,
    group = "Forest type"
  ) %>% 
  addLayersControl(
    baseGroups = c("Positron", "Toner", "Terrain"),
    overlayGroups = c("All records", "Record basis", "Forest type"), 
    options = layersControlOptions(collapsed = FALSE)) %>% 
  hideGroup(c("Record basis", "Forest type")) %>% 
  addFullscreenControl()

```
**Figure2** Locations for occurrence records of reptiles in the ACT. Interactive layers in the top right corner allow records to be differentiated based on the type of record (ALA id: basisOfRecord) and forest type (ALA id: cl10902) associated with each record.  


**Table 1** Occurrence records for reptiles in the ACT. Columns may be sorted by clicking on column names, or filtered using the search bars under each column header. A global search bar in the top right corner enables searching the whole table.  
```{r table-all }

# remove cols not of interest in a table
reptilia_subset <- reptilia_tidy %>% 
  select(eventDate:basisOfRecord, forestType)

reactable(
  reptilia_subset,
  columns = list(
    eventDate = colDef(name = "Date"),
    scientificName = colDef(name = "Species"),
    genus = colDef(name = "Genus"),
    family = colDef(name = "Family"),
    order = colDef(name = "Order"),
    dataResourceName = colDef(name = "Source"),
    basisOfRecord = colDef(name = "Record type"),
    forestType = colDef(name = "Forest type")
  ),
  showSortable = TRUE,
  filterable = TRUE,
  searchable = TRUE,
  showPageInfo = FALSE,
  striped = TRUE
)
```


### Citation  
`r citation_text`

